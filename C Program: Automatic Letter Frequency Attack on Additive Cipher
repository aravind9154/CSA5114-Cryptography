#include <stdio.h>
#include <string.h>
#include <ctype.h>
#include <math.h>

#define MAX 10000

// English letter frequencies (percent)
double englishFreq[26] = {
    8.167, 1.492, 2.782, 4.253, 12.702, 2.228,
    2.015, 6.094, 6.966, 0.153, 0.772, 4.025,
    2.406, 6.749, 7.507, 1.929, 0.095, 5.987,
    6.327, 9.056, 2.758, 0.978, 2.360, 0.150,
    1.974, 0.074
};

// Structure to store shift and score
typedef struct {
    int shift;
    double score;
} Result;

// Sort results by score (ascending)
void sortResults(Result r[], int n) {
    Result temp;
    for(int i=0;i<n-1;i++){
        for(int j=i+1;j<n;j++){
            if(r[i].score > r[j].score){
                temp = r[i];
                r[i] = r[j];
                r[j] = temp;
            }
        }
    }
}

// Apply a Caesar shift
void decrypt(char *cipher, char *plain, int shift) {
    for(int i=0; cipher[i]; i++) {
        char c = cipher[i];
        if(isalpha(c)) {
            char base = isupper(c) ? 'A' : 'a';
            plain[i] = ( (c - base - shift + 26) % 26 ) + base;
        } else plain[i] = c;
    }
}

// Compute Chi-square score
double chiSquare(char *text) {
    int count[26] = {0};
    int total = 0;
    for(int i=0; text[i]; i++) {
        if(isalpha(text[i])) {
            count[tolower(text[i]) - 'a']++;
            total++;
        }
    }
    double score = 0.0;
    for(int i=0;i<26;i++){
        double expected = englishFreq[i] * total / 100.0;
        score += (count[i] - expected) * (count[i] - expected) / expected;
    }
    return score;
}

int main() {
    char cipher[MAX], temp[MAX];
    int topN;

    printf("Enter ciphertext: ");
    fgets(cipher, MAX, stdin);

    printf("How many top plaintext guesses do you want? ");
    scanf("%d", &topN);

    Result results[26];

    for(int shift = 0; shift < 26; shift++) {
        decrypt(cipher, temp, shift);
        results[shift].shift = shift;
        results[shift].score = chiSquare(temp);
    }

    sortResults(results, 26);

    printf("\nTop %d plaintext guesses:\n", topN);
    for(int i=0; i<topN; i++) {
        char resultText[MAX];
        decrypt(cipher, resultText, results[i].shift);
        printf("\nRank %d (shift = %d, score = %.4f):\n%s\n",
               i+1, results[i].shift, results[i].score, resultText);
    }

    return 0;
}
