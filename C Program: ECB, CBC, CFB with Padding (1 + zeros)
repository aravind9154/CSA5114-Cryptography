#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <openssl/evp.h>
#include <openssl/rand.h>

#define BLOCK_SIZE 16  // Using AES block size = 128 bits

// 1-bit padding + zero padding
int pad_message(const unsigned char *in, int in_len, unsigned char *out)
{
    memcpy(out, in, in_len);
    out[in_len] = 0x80; // binary 10000000
    for (int i = in_len + 1; i < BLOCK_SIZE; i++)
        out[i] = 0x00;
    return BLOCK_SIZE;
}

void print_hex(const char *label, unsigned char *data, int len)
{
    printf("%s", label);
    for (int i = 0; i < len; i++) printf("%02X ", data[i]);
    printf("\n");
}

void encrypt_mode(const EVP_CIPHER *cipher, const char *mode_name)
{
    unsigned char key[16], iv[16];
    RAND_bytes(key, 16);
    RAND_bytes(iv, 16);

    unsigned char plaintext[BLOCK_SIZE] = "HELLO123";  // 8 bytes
    unsigned char padded[BLOCK_SIZE];

    int padded_len = pad_message(plaintext, strlen((char *)plaintext), padded);

    unsigned char ciphertext[128];
    int len, total = 0;

    EVP_CIPHER_CTX *ctx = EVP_CIPHER_CTX_new();
    EVP_EncryptInit_ex(ctx, cipher, NULL, key, iv);
    EVP_EncryptUpdate(ctx, ciphertext, &len, padded, padded_len);
    total = len;
    EVP_EncryptFinal_ex(ctx, ciphertext + total, &len);
    total += len;
    EVP_CIPHER_CTX_free(ctx);

    printf("\n=== %s MODE ===\n", mode_name);
    print_hex("KEY: ", key, 16);

    if (iv != NULL)
        print_hex("IV : ", iv, 16);

    print_hex("PLAINTEXT PADDED: ", padded, padded_len);
    print_hex("CIPHERTEXT       : ", ciphertext, total);
}

int main()
{
    encrypt_mode(EVP_aes_128_ecb(), "ECB");
    encrypt_mode(EVP_aes_128_cbc(), "CBC");
    encrypt_mode(EVP_aes_128_cfb128(), "CFB");

    return 0;
}
