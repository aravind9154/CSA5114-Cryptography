#include <stdio.h>
#include <string.h>
#include <ctype.h>
#include <math.h>

#define MAX 10000
#define TOP_VARIANTS 40   // number of trial mappings

// English letter frequency from highest to lowest
char englishOrder[26] = {
    'E','T','A','O','I','N','S','H','R','D','L','C',
    'U','M','W','F','G','Y','P','B','V','K','J','X','Q','Z'
};

typedef struct {
    char plaintext[MAX];
    double score;
} Candidate;

// compute chi-square score
double chiSquare(const char *text) {
    int count[26] = {0}, total = 0;
    for(int i=0;text[i];i++){
        if(isalpha(text[i])) {
            count[tolower(text[i])-'a']++;
            total++;
        }
    }
    double englishFreq[26] = {
        8.167,1.492,2.782,4.253,12.702,2.228,2.015,6.094,6.966,
        0.153,0.772,4.025,2.406,6.749,7.507,1.929,0.095,5.987,
        6.327,9.056,2.758,0.978,2.360,0.150,1.974,0.074
    };

    double score = 0;
    for(int i=0;i<26;i++){
        double expected = englishFreq[i] * total / 100.0;
        if(expected > 0)
            score += (count[i] - expected) * (count[i] - expected) / expected;
    }
    return score;
}

// decrypt using a mapping
void decrypt(const char *cipher, char *plain, char map[26]) {
    for(int i=0; cipher[i]; i++){
        if(isalpha(cipher[i])) {
            char c = tolower(cipher[i]);
            plain[i] = map[c-'a'];
        } else plain[i] = cipher[i];
    }
}

// sort candidates by score
void sort(Candidate c[], int n) {
    Candidate temp;
    for(int i=0;i<n;i++){
        for(int j=i+1;j<n;j++){
            if(c[i].score > c[j].score){
                temp = c[i];
                c[i] = c[j];
                c[j] = temp;
            }
        }
    }
}

int main() {
    char cipher[MAX];
    int topN;

    printf("Enter ciphertext: ");
    fgets(cipher, MAX, stdin);

    printf("How many top plaintext guesses do you want? ");
    scanf("%d", &topN);

    int freq[26] = {0};
    int len = strlen(cipher);

    // count frequencies in ciphertext
    for(int i=0;i<len;i++){
        if(isalpha(cipher[i]))
            freq[tolower(cipher[i])-'a']++;
    }

    // list cipher letters sorted by frequency
    int order[26];
    for(int i=0;i<26;i++) order[i]=i;

    // sort by frequency descending
    for(int i=0;i<25;i++){
        for(int j=i+1;j<26;j++){
            if(freq[order[j]] > freq[order[i]]) {
                int t = order[i];
                order[i] = order[j];
                order[j] = t;
            }
        }
    }

    Candidate results[TOP_VARIANTS];
    int variants = 0;

    // generate several trial mappings
    for(int k=0; k<TOP_VARIANTS; k++){
        char map[26];
        
        // map cipher â†’ english order with slight variation
        for(int i=0;i<26;i++){
            int idx = (i + k) % 26;
            map[order[i]] = tolower(eng
